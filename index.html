<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MinistryOS Pro</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Calendar Styles */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .cal-day { min-height: 45px; border-radius: 6px; position: relative; font-size: 11px; padding: 4px; display: flex; flex-direction: column; align-items: center; }
        .current-day { border: 1px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-bottom: 2px; }
        
        /* Inputs */
        input, textarea, select { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 8px; padding: 10px; width: 100%; outline: none; }
        input:focus, textarea:focus { border-color: #3b82f6; }
        label { font-size: 11px; text-transform: uppercase; color: #94a3b8; font-weight: bold; margin-bottom: 4px; display: block; }
    </style>
</head>
<body>

    <div id="root" class="h-screen w-screen bg-slate-900"></div>

    <script type="text/babel">
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyCWTjZ5P-cvfL3bgFOrl53qRQEfWP35ThE",
          authDomain: "crossyth-dashboard.firebaseapp.com",
          projectId: "crossyth-dashboard",
          storageBucket: "crossyth-dashboard.firebasestorage.app",
          messagingSenderId: "999386499044",
          appId: "1:999386499044:web:49e4bc10c133b4c20f29f1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. HARDCODED ICONS (To Fix The Crash) ---
        const Icons = {
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            CheckSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        };

        // --- 3. UTILS: THE BRAIN (Logic Engine) ---
        const generateSmartWorkflow = (title, desc, dueDate) => {
            const tasks = [];
            const due = new Date(dueDate);
            const calcDate = (days) => {
                const d = new Date(due);
                d.setDate(d.getDate() - days);
                return d.toISOString().split('T')[0];
            };

            // 1. Standard Project Tasks
            tasks.push({ txt: "Concept & Budget Approval", date: calcDate(30), done: false });
            tasks.push({ txt: "Team Recruitment", date: calcDate(21), done: false });
            tasks.push({ txt: "Supplies/Materials Ordered", date: calcDate(14), done: false });

            // 2. Contextual Tasks (The AI Part)
            const text = (title + " " + (desc || "")).toLowerCase();
            
            if(text.includes('food') || text.includes('dinner') || text.includes('lunch') || text.includes('catering')) {
                tasks.push({ txt: "Finalize Menu & Caterer", date: calcDate(10), done: false });
                tasks.push({ txt: "Shop for Groceries/Supplies", date: calcDate(2), done: false });
            }
            if(text.includes('music') || text.includes('worship') || text.includes('band')) {
                tasks.push({ txt: "Confirm Band/Worship Leader", date: calcDate(20), done: false });
                tasks.push({ txt: "Send Setlist to Production", date: calcDate(5), done: false });
            }
            if(text.includes('guest') || text.includes('speaker')) {
                tasks.push({ txt: "Book Travel/Lodging for Guest", date: calcDate(25), done: false });
            }
            if(text.includes('outreach') || text.includes('community')) {
                tasks.push({ txt: "Contact Local Partners", date: calcDate(15), done: false });
                tasks.push({ txt: "Print Flyers/Handouts", date: calcDate(7), done: false });
            }

            // 3. The "2 Weeks Out" Target
            tasks.push({ txt: "TARGET COMPLETION (Dry Run)", date: calcDate(14), done: false, isTarget: true });
            tasks.push({ txt: "Final Walkthrough", date: calcDate(1), done: false });

            return tasks.sort((a,b) => a.date.localeCompare(b.date));
        };

        // --- 4. APP CONTAINER ---
        function App() {
            const [tab, setTab] = React.useState('calendar');

            return (
                <div className="flex flex-col h-full w-full bg-slate-900 text-white safe-pb">
                    
                    {/* HEADER */}
                    <div className="h-16 flex items-center justify-between px-4 bg-slate-900 border-b border-slate-800 z-10 shrink-0">
                        <div>
                            <span className="font-bold text-lg tracking-tight text-white block leading-none">
                                {tab === 'calendar' ? 'Master Calendar' : 
                                 tab === 'benson' ? 'Benson Campus' :
                                 tab === 'prod' ? 'Production' :
                                 tab === 'crossyth' ? 'CrossYTH' : 'CrossLink'}
                            </span>
                            <span className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">MinistryOS</span>
                        </div>
                        <div className="w-9 h-9 bg-slate-800 rounded-full flex items-center justify-center text-xs font-bold text-slate-400 border border-slate-700">PC</div>
                    </div>

                    {/* CONTENT AREA */}
                    <div className="flex-1 overflow-y-auto bg-slate-950 relative">
                        {tab === 'calendar' && <CalendarView />}
                        {tab === 'benson' && <GenericManager category="Benson" color="red" />}
                        {tab === 'prod' && <ProductionManager />}
                        {tab === 'crossyth' && <UnifiedManager category="CrossYTH" color="blue" />}
                        {tab === 'crosslink' && <UnifiedManager category="CrossLink" color="purple" />}
                    </div>

                    {/* BOTTOM NAV */}
                    <div className="h-20 bg-slate-900 border-t border-slate-800 flex justify-around items-start pt-3 text-[10px] shrink-0 safe-pb">
                        <NavBtn id="calendar" icon={Icons.Calendar} label="Calendar" active={tab} set={setTab} />
                        <NavBtn id="benson" icon={Icons.MapPin} label="Benson" active={tab} set={setTab} />
                        <NavBtn id="prod" icon={Icons.Mic} label="Prod" active={tab} set={setTab} />
                        <NavBtn id="crossyth" icon={Icons.Users} label="YTH" active={tab} set={setTab} />
                        <NavBtn id="crosslink" icon={Icons.Book} label="Link" active={tab} set={setTab} />
                    </div>
                </div>
            );
        }

        // --- 5. CALENDAR VIEW ---
        function CalendarView() {
            const [date, setDate] = React.useState(new Date());
            const [items, setItems] = React.useState([]);

            // Fetch ALL items with dates
            React.useEffect(() => {
                const unsub1 = db.collection('projects').onSnapshot(snap => {
                    const projs = snap.docs.map(d => ({...d.data(), type: 'project'}));
                    setItems(prev => [...projs]); 
                });
                return () => unsub1();
            }, []);

            const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            const getItemsForDay = (day) => {
                const dateStr = new Date(date.getFullYear(), date.getMonth(), day).toISOString().split('T')[0];
                return items.filter(i => i.dueDate === dateStr || i.date === dateStr);
            };

            const getColor = (cat, status) => {
                if(status === 'Pending') return 'bg-gray-600'; 
                if(cat === 'Benson') return 'bg-red-500';
                if(cat === 'Production') return 'bg-yellow-500';
                if(cat === 'CrossYTH') return 'bg-blue-500';
                if(cat === 'CrossLink') return 'bg-purple-500';
                return 'bg-white';
            };

            return (
                <div className="p-4">
                    <div className="flex justify-between items-center mb-6">
